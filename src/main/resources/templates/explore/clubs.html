<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Explore Clubs</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 24px; }
        form.filters { display: grid; grid-template-columns: 1fr 220px 260px 160px auto; gap: 8px; margin-bottom: 14px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
        .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; }
        .counts { color: #666; font-size: 0.9em; margin-top: 6px; }
        .actions { margin-top: 8px; display: flex; gap: 8px; align-items: center; }
        nav a { margin: 0 6px; }
        button.following { background: #eee; }
    </style>
</head>
<body>
<h2>Explore Clubs</h2>

<form class="filters" th:action="@{/explore/clubs}" method="get">
    <input type="text" name="q" placeholder="Search clubs or universities" th:value="${q}">
    <select name="countryId">
        <option value="" th:selected="${countryId == null}">All countries</option>
        <option th:each="co : ${countries}" th:value="${co.id}"
                th:text="${co.name}" th:selected="${countryId != null and countryId == co.id}">Country</option>
    </select>
    <select name="universityId" th:disabled="${countryId == null}">
        <option value="" th:selected="${universityId == null}">All universities</option>
        <option th:each="u : ${universities}" th:value="${u.id}"
                th:text="${u.name}" th:selected="${universityId != null and universityId == u.id}">University</option>
    </select>
    <select name="sort">
        <option value="name" th:selected="${sort == 'name'}">Sort: Name</option>
        <option value="followers" th:selected="${sort == 'followers'}">Sort: Followers</option>
        <option value="members" th:selected="${sort == 'members'}">Sort: Members</option>
        <option value="recent" th:selected="${sort == 'recent'}">Sort: Most recent post</option>
    </select>
    <div>
        <button type="submit">Filter</button>
        <a th:href="@{/explore/clubs}" style="margin-left:6px;">Clear</a>
    </div>
</form>

<div class="grid">
    <div class="card" th:each="c : ${clubs.content}">
        <div><strong th:text="${c.name}">Club Name</strong></div>
        <div th:text="${c.universityName}">University</div>
        <div class="counts">
            <span th:text="${c.followerCount}">0</span> followers Â·
            <span th:text="${c.memberCount}">0</span> members
        </div>
        <!-- Apply button or status -->
        <span th:if="${memberClubIds.contains(c.id)}" style="margin-left:auto; color:#0a7f27;">Member</span>

        <form th:if="${eligibleApplyIds.contains(c.id)}"
              th:action="@{'/clubs/' + ${c.id} + '/apply'}" method="post" style="margin:0; margin-left:auto;">
            <input type="hidden" name="back" th:value="${back}"/>
            <input type="hidden" name="applicationText" value="I'd like to join this club."/>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit">Apply</button>
        </form>

        <span th:if="${applicationStatuses[c.id] != null}" style="margin-left:auto;">
  Applied: <strong th:text="${applicationStatuses[c.id]}">PENDING</strong>
</span>

        <div class="actions">
            <a th:href="@{'/clubs/' + ${c.id}}">View club</a>

            <form th:action="@{'/clubs/' + ${c.id} + '/follow'}" method="post" style="margin:0;">
                <input type="hidden" name="back" th:value="${back}"/>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit"
                        th:classappend="${followedIds.contains(c.id)} ? ' following' : ''"
                        th:text="${followedIds.contains(c.id)} ? 'Following' : 'Follow'">
                    Follow
                </button>
            </form>
        </div>
    </div>
</div>

<nav th:if="${clubs.totalPages > 1}" style="margin-top: 14px;">
    <a th:if="${!clubs.first}" th:href="@{/explore/clubs(q=${q}, countryId=${countryId}, universityId=${universityId}, sort=${sort}, page=${page-1}, size=${size})}">Prev</a>
    <span>Page <span th:text="${clubs.number + 1}"></span> of <span th:text="${clubs.totalPages}"></span></span>
    <a th:if="${!clubs.last}" th:href="@{/explore/clubs(q=${q}, countryId=${countryId}, universityId=${universityId}, sort=${sort}, page=${page+1}, size=${size})}">Next</a>
</nav>
</body>
</html>